/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ye=Object.defineProperty;var lt=Object.getOwnPropertyDescriptor;var pt=Object.getOwnPropertyNames;var mt=Object.prototype.hasOwnProperty;var dt=(a,e)=>{for(var t in e)ye(a,t,{get:e[t],enumerable:!0})},ht=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of pt(e))!mt.call(a,i)&&i!==t&&ye(a,i,{get:()=>e[i],enumerable:!(r=lt(e,i))||r.enumerable});return a};var gt=a=>ht(ye({},"__esModule",{value:!0}),a);var ft={};dt(ft,{default:()=>Ee});module.exports=gt(ft);var ct=require("obsidian");var Ce=require("obsidian");var X=require("obsidian"),ie=class extends X.Modal{constructor(e,t,r){super(e),this.folderName=t,this.folderPath=r,this.result=!1,this.modalPromise=new Promise(i=>{this.resolveModalPromise=i})}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:`[ChatGPT MD] No ${this.folderName} folder found.`}),e.createEl("p",{text:`If you choose "Yes, Create", the plugin will automatically create a folder at: ${this.folderPath}. You can change this path in the plugin settings.`}),new X.Setting(e).addButton(t=>t.setButtonText("Yes, Create Folder").setTooltip("Create folder").setCta().onClick(()=>{this.result=!0,this.resolveModalPromise(this.result),this.close()})),new X.Setting(e).addButton(t=>t.setButtonText("No, I'll create it myself").setTooltip("Cancel").setCta().onClick(()=>{this.result=!1,this.resolveModalPromise(this.result),this.close()}))}waitForModalValue(){return this.modalPromise}onClose(){let{contentEl:e}=this;e.empty()}};var be=async(a,e,t)=>{let r=new ie(a,e,t);r.open();let i=await r.waitForModalValue();return i&&await a.vault.createFolder(t),i};var W=class{constructor(e){this.app=e}async writeInferredTitle(e,t){var s,c;let r=e.file;if(!r)throw new Error("No file is currently open");let i=this.sanitizeFileName(t),n=(c=(s=r.parent)==null?void 0:s.path)!=null?c:"/",o=`${n}/${i}.md`;for(let l=1;await this.app.vault.adapter.exists(o);l++)o=`${n}/${i} (${l}).md`;try{await this.app.fileManager.renameFile(r,o)}catch(l){throw new Ce.Notice("[ChatGPT MD] Error writing inferred title to editor"),l}}sanitizeFileName(e){return e.replace(/[\\/:*?"<>|]/g,"-")}async ensureFolderExists(e,t){return!await this.app.vault.adapter.exists(e)&&!await be(this.app,t,e)?(new Ce.Notice(`[ChatGPT MD] No ${t} found. One must be created to use the plugin. Set one in settings and make sure it exists.`),!1):!0}async createNewFile(e,t){return this.app.vault.create(e,t)}async readFile(e){return this.app.vault.read(e)}async getLinkedNoteContent(e){try{let t=this.app.metadataCache.getFirstLinkpathDest(e,"");return t?await this.app.vault.read(t):null}catch(t){return null}}formatDate(e,t){return e.toISOString().replace(/[-:]/g,"").replace(/\..+/,"")}};var Xe=require("obsidian");var g="ollama",h="openai",d="openrouter",u="lmstudio",f="anthropic",S="gemini",Ne={[h]:"/v1/chat/completions",[d]:"/api/v1/chat/completions",[g]:"/api/chat",[u]:"/v1/chat/completions",[f]:"/v1/messages",[S]:"/v1beta/models/{model}:generateContent"},Oe="add-comment-block",Fe="add-hr",xe="call-chatgpt-api",Le="stop-streaming",De="move-to-chat",ke="infer-title",Ge="choose-chat-template",Ue="clear-chat";var _e="chatFolder",$e="chatTemplateFolder",E=`

`,He=/\[\[([^\][]+)\]\]/g,Ve=/\[([^\]]+)\]\(([^()]+)\)/g,Ke=`=begin-chatgpt-md-comment${E}`,Be="=end-chatgpt-md-comment",We=3,Te=6,je="English",qe=4,ne="YYYYMMDDhhmmss",Ye="Failed to fetch",Me="__chatgpt_plugin",j=`<hr class="${Me}">`,L="role::",F="assistant",Pe="developer",D="system",b="user",oe=`---
system_commands: ['I am a helpful assistant.']
frequency_penalty: 0
max_tokens: 300
model: gpt-4.1-mini
presence_penalty: 0
stream: true
temperature: 1
---`,K=6e3,Z=`You are an AI assistant integrated into Obsidian through the ChatGPT MD plugin. You are helping a user who is working within their Obsidian vault - a personal knowledge management system where they store notes, thoughts, and information in Markdown format.

Key context:
- The user is writing in Markdown format within Obsidian
- They may reference other notes in their vault using [[wiki links]] or standard [markdown links](url)
- Your responses will be inserted directly into their Markdown document
- Be concise but helpful, and format your responses appropriately for Markdown
- If you provide code examples, use proper markdown code blocks with language specification
- When suggesting organizational strategies, consider that this is within a personal knowledge management context
- The user may be taking notes, brainstorming, writing, researching, or organizing information

Code block formatting requirements:
- Code blocks must start and end with exactly 3 backticks (\`\`\`) on a new line
- There should be no whitespace before the opening or closing backticks
- The language name should be specified immediately after the opening backticks
- The actual code should start on a new line after the language specification
- Example format:
\`\`\`javascript
console.log("Hello World");
\`\`\`

Inline code formatting requirements:
- Use single backticks (\`) for inline code references like filenames (e.g., \`example.md\`), variable names (e.g., \`myVariable\`), or short code snippets referenced within a paragraph.
- Always ensure that single backticks are properly closed to avoid breaking Markdown rendering. For example, use \`code\` not \`code.

Table formatting requirements:
- Use standard Markdown table syntax.
- Tables should NOT be wrapped in code blocks.

Respond naturally and helpfully while being mindful of this Obsidian/note-taking context.`;var ze=a=>{let t=(a.match(/```/g)||[]).length%2!==0;return t};var ut=a=>{let e=a.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&").replace("YYYY","\\d{4}").replace("MM","\\d{2}").replace("DD","\\d{2}").replace("hh","\\d{2}").replace("mm","\\d{2}").replace("ss","\\d{2}");return new RegExp(`^${e}$`)},Je=(a="",e)=>(a==null?void 0:a.length)==e.length&&ut(e).test(a),k=a=>a===0?"":a>Te?"#".repeat(Te)+" ":"#".repeat(a)+" ",Q=(a,e,t)=>`${E}${j}${E}${a}${L}${e}${t?`<span style="font-size: small;"> (${t})</span>`:""}${E}`,we=a=>{let t=a.replace(/^---\n/,"").replace(/\n---$/,"").split(`
`),r={},i=null,n=[];for(let o=0;o<t.length;o++){let s=t[o].trim();if(!s)continue;if(i!==null)if(s.startsWith("-")){let m=s.substring(1).trim();(m.startsWith("'")&&m.endsWith("'")||m.startsWith('"')&&m.endsWith('"'))&&(m=m.substring(1,m.length-1)),n.push(m);continue}else r[i]=n,i=null,n=[];let c=s.indexOf(":");if(c===-1)continue;let l=s.substring(0,c).trim(),p=s.substring(c+1).trim();if(p===""&&o+1<t.length&&t[o+1].trim().startsWith("-")){i=l,n=[];continue}p.startsWith("[")&&p.endsWith("]")?r[l]=p.slice(1,-1).split(",").map(m=>{let A=m.trim();return A.startsWith("'")&&A.endsWith("'")||A.startsWith('"')&&A.endsWith('"')?A.slice(1,-1):A}):p==="true"?r[l]=!0:p==="false"?r[l]=!1:p==="null"?r[l]=null:isNaN(Number(p))?r[l]=p:r[l]=Number(p)}return i!==null&&(r[i]=n),r};var q=class{constructor(e){this.app=e}async readFrontmatter(e){try{let t=this.app.metadataCache.getFileCache(e);return t!=null&&t.frontmatter?{...t.frontmatter}:null}catch(t){return null}}async writeFrontmatter(e,t){try{await this.app.fileManager.processFrontMatter(e,r=>{Object.keys(r).forEach(i=>{delete r[i]}),Object.assign(r,t)})}catch(r){throw new Error(`Failed to write frontmatter: ${r.message}`)}}async updateFrontmatterField(e,t,r){try{await this.app.fileManager.processFrontMatter(e,i=>{i[t]=r})}catch(i){throw new Error(`Failed to update frontmatter field '${t}': ${i.message}`)}}async mergeFrontmatter(e,t){try{await this.app.fileManager.processFrontMatter(e,r=>{Object.assign(r,t)})}catch(r){throw new Error(`Failed to merge frontmatter: ${r.message}`)}}hasFrontmatter(e){try{let t=this.app.metadataCache.getFileCache(e);return!!(t!=null&&t.frontmatter&&Object.keys(t.frontmatter).length>0)}catch(t){return!1}}async removeFrontmatterField(e,t){try{await this.app.fileManager.processFrontMatter(e,r=>{delete r[t]})}catch(r){throw new Error(`Failed to remove frontmatter field '${t}': ${r.message}`)}}async removeFrontmatterFields(e,t){try{await this.app.fileManager.processFrontMatter(e,r=>{t.forEach(i=>{delete r[i]})})}catch(r){throw new Error(`Failed to remove frontmatter fields: ${r.message}`)}}async clearFrontmatter(e){try{await this.app.fileManager.processFrontMatter(e,t=>{Object.keys(t).forEach(r=>{delete t[r]})})}catch(t){throw new Error(`Failed to clear frontmatter: ${t.message}`)}}async getFrontmatterField(e,t,r){try{let i=await this.readFrontmatter(e);return!i||!(t in i)?r:i[t]}catch(i){return r}}async hasFrontmatterField(e,t){try{let r=await this.readFrontmatter(e);return!!(r&&t in r)}catch(r){return!1}}};var Y=class{constructor(e){this.app=e;e&&(this.frontmatterManager=new q(e))}addHorizontalRule(e,t,r){let i=`${E}<hr class="${Me}">${E}${k(r)}${L}${t}${E}`,n=e.getCursor();e.replaceRange(i,n),e.setCursor(n.line+i.split(`
`).length-1,0)}appendMessage(e,t,r){let i=k(r),n=Q(i,F),o=Q(i,b);e.replaceRange(`${n}${t}${o}`,e.getCursor())}async clearChat(e){let t="";if(this.app&&this.frontmatterManager){let r=this.app.workspace.getActiveViewOfType(Xe.MarkdownView);if(r!=null&&r.file)try{let i=await this.frontmatterManager.readFrontmatter(r.file);if(i&&Object.keys(i).length>0){let n=Object.entries(i).filter(([o])=>o!=="position").map(([o,s])=>typeof s=="string"?`${o}: "${s}"`:`${o}: ${s}`);n.length>0&&(t=`---
${n.join(`
`)}
---

`)}}catch(i){}}e.setValue(t),t?e.setCursor({line:e.lastLine()+1,ch:0}):e.setCursor({line:0,ch:0})}moveCursorToEnd(e){try{let r={line:e.lastLine()+1,ch:0};e.setCursor(r)}catch(t){throw new Error("Error moving cursor to end of file"+t)}}addCommentBlock(e,t,r){let i=e.getCursor(),n=`${t}${E}${r}`;e.replaceRange(n,i),e.setCursor({line:i.line+1,ch:i.ch})}};var z=class{constructor(e,t){this.fileService=e;this.notificationService=t}findLinksInMessage(e){let t=[{regex:He,fullMatchIndex:0,titleIndex:1},{regex:Ve,fullMatchIndex:0,titleIndex:2}],r=[],i=new Set;for(let{regex:n,fullMatchIndex:o,titleIndex:s}of t)for(let c of e.matchAll(n)){let l=c[o],p=c[s];p&&!i.has(p)&&!p.startsWith("http://")&&!p.startsWith("https://")&&(r.push({link:l,title:p}),i.add(p))}return r}splitMessages(e){return e?e.split(j):[]}removeYAMLFrontMatter(e){if(!e||!e.trim().startsWith("---"))return e;let t=e.split(`
`),r=-1;for(let i=1;i<t.length;i++)if(t[i].trim()==="---"){r=i;break}return r===-1?e:t.slice(r+1).join(`
`).trim()}removeCommentsFromMessages(e){try{let t=/=begin-chatgpt-md-comment[\s\S]*?=end-chatgpt-md-comment/g;return e.replace(t,"")}catch(t){return this.notificationService.showError("Error removing comments from messages: "+t),e}}extractRoleAndMessage(e){try{if(!e.includes(L))return{role:b,content:e};let[t,...r]=e.split(L)[1].split(`
`);return{role:this.cleanupRole(t),content:r.join(`
`).trim()}}catch(t){return this.notificationService.showError("Failed to extract role and message: "+t),{role:b,content:e}}}cleanupRole(e){let t=e.trim().toLowerCase(),i=[b,F].find(n=>t.includes(n));return i||(this.notificationService.showWarning(`Unknown role: "${e}", defaulting to user`),b)}cleanMessagesFromNote(e){return this.splitMessages(this.removeYAMLFrontMatter(e.getValue())).map(r=>this.removeCommentsFromMessages(r))}async getMessagesFromEditor(e,t){let r=this.cleanMessagesFromNote(e);r=await Promise.all(r.map(async n=>{let o=this.findLinksInMessage(n);for(let s of o)try{let c=await this.fileService.getLinkedNoteContent(s.title);if(c){let l=new RegExp(`${E}${j}${E}#+ ${L}(?:${b}|${F}).*$`,"gm");c=c==null?void 0:c.replace(l,""),c=this.removeYAMLFrontMatter(c)||null,n=n.replace(new RegExp(this.escapeRegExp(s.link),"g"),`${E}${s.title}${E}${c}${E}`)}}catch(c){}return n}));let i=r.map(n=>this.extractRoleAndMessage(n));return{messages:r,messagesWithRole:i}}addSystemCommandsToMessages(e,t){return!t||t.length===0?e:[...t.map(i=>({role:"system",content:i})),...e]}getHeaderRole(e,t,r){return`${E}${j}${E}${e}${L}${t}${r?`<span style="font-size: small;"> (${r})</span>`:""}${E}`}unfinishedCodeBlock(e){let t=e.match(/```/g);return t!==null&&t.length%2!==0}formatMessage(e,t,r){let i=k(t);return`${this.getHeaderRole(i,e.role,r)}${e.content}`}appendMessage(e,t,r){let i=k(r),n=this.getHeaderRole(i,F),o=this.getHeaderRole(i,b);e.replaceRange(`${n}${t}${o}`,e.getCursor())}processResponse(e,t,r){t.mode==="streaming"?t.wasAborted||this.processStreamingResponse(e,r):this.processStandardResponse(e,t,r)}processStreamingResponse(e,t){let r=k(t.headingLevel),i=this.getHeaderRole(r,b);e.replaceRange(i,e.getCursor());let n=e.getCursor(),o={line:n.line,ch:n.ch+i.length};e.setCursor(o)}processStandardResponse(e,t,r){let i=typeof t=="object"&&t.fullString||t,n=typeof t=="object"?t.model:void 0,o=this.unfinishedCodeBlock(i)?i+"\n```":i,s=k(r.headingLevel),c=this.getHeaderRole(s,F,n),l=this.getHeaderRole(s,b);e.replaceRange(`${c}${o}${l}`,e.getCursor())}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};var G=require("obsidian");var H=require("obsidian"),se=class extends H.SuggestModal{constructor(e,t,r){super(e),this.settings=t,this.titleDate=r}getFilesInChatFolder(){let e=this.app.vault.getAbstractFileByPath(this.settings.chatTemplateFolder);if(e!=null)return e.children;throw new H.Notice(`Error getting folder: ${this.settings.chatTemplateFolder}`),new Error(`Error getting folder: ${this.settings.chatTemplateFolder}`)}getSuggestions(e){let t=this.getFilesInChatFolder();return e==""?t.map(r=>({title:r.basename,file:r})).sort((r,i)=>r.title.localeCompare(i.title)):t.filter(r=>r.basename.toLowerCase().includes(e.toLowerCase())).map(r=>({title:r.basename,file:r})).sort((r,i)=>r.title.localeCompare(i.title))}renderSuggestion(e,t){t.createEl("div",{text:e.title})}async onChooseSuggestion(e,t){new H.Notice(`Selected ${e.title}`);let r=await this.app.vault.read(e.file),i=r;!/^---\n[\s\S]*?\n---/.test(r)&&this.settings.defaultChatFrontmatter&&(i=this.settings.defaultChatFrontmatter+`

`+r);let o=`${this.titleDate} ${e.title}`,s=(0,H.normalizePath)(`${this.settings.chatFolder}/${o}.md`),c=1;for(;await this.app.vault.adapter.exists(s);)s=(0,H.normalizePath)(`${this.settings.chatFolder}/${o} (${c}).md`),c++;try{let l=await this.app.vault.create(s,i);await this.app.workspace.openLinkText(l.basename,"",!0)}catch(l){}}};var J=class{constructor(e,t,r){this.app=e;this.fileService=t;this.editorContentService=r}async createNewChatFromTemplate(e,t){try{if(!e.chatFolder||e.chatFolder.trim()===""){new G.Notice("[ChatGPT MD] No chat folder value found. Please set one in settings.");return}if(!e.chatTemplateFolder||e.chatTemplateFolder.trim()===""){new G.Notice("[ChatGPT MD] No chat template folder value found. Please set one in settings.");return}if(!await this.fileService.ensureFolderExists(e.chatFolder,_e)||!await this.fileService.ensureFolderExists(e.chatTemplateFolder,$e))return;new se(this.app,e,t).open()}catch(r){new G.Notice("[ChatGPT MD] Error in Create new chat from template, check console")}}async createNewChatWithHighlightedText(e,t){try{let r=e.getSelection();if(!t.chatFolder||t.chatFolder.trim()===""){new G.Notice("[ChatGPT MD] No chat folder value found. Please set one in settings.");return}if(!await this.fileService.ensureFolderExists(t.chatFolder,_e))return;let n=`${this.fileService.formatDate(new Date,t.dateFormat)}.md`,o=`${t.chatFolder}/${n}`,s="";t.defaultChatFrontmatter&&(s=t.defaultChatFrontmatter+`

`),r&&(s+=r);let c=await this.fileService.createNewFile(o,s);await this.app.workspace.openLinkText(c.basename,"",!0,{state:{mode:"source"}});let l=this.app.workspace.getActiveViewOfType(G.MarkdownView);if(!l){new G.Notice("No active markdown editor found.");return}l.editor.focus(),this.editorContentService.moveCursorToEnd(l.editor)}catch(r){new G.Notice("[ChatGPT MD] Error in Create new chat with highlighted text, check console")}}};var at=require("obsidian");var Ie=require("obsidian");var Ze=require("obsidian"),N=class{showNotification(e,t=5e3){new Ze.Notice(e,t)}formatChatMessage(e,t=!1){return t?`I am sorry. ${e}`:e}showSuccess(e){this.showNotification(`\u2705 ${e}`,3e3)}showWarning(e){this.showNotification(`\u26A0\uFE0F ${e}`,5e3)}showError(e){this.showNotification(`\u274C ${e}`,7e3)}};function M(a){return!!a&&a.trim()!==""}var v=class{constructor(e){this.notificationService=e||new N}getApiKey(e,t){switch(t){case h:return e.apiKey;case d:return e.openrouterApiKey;case f:return e.anthropicApiKey;case S:return e.geminiApiKey;case g:return"";case u:return"";default:return""}}validateApiKey(e,t){if(!(t===g||t===u)&&!M(e)){let r=`${t} API key is missing or invalid. Please add your ${t} API key in the settings.`;throw this.notificationService.showError(r),new Error(r)}}createAuthHeaders(e,t){let r={"Content-Type":"application/json"};switch(t){case h:r.Authorization=`Bearer ${e}`;break;case d:r.Authorization=`Bearer ${e}`,r["HTTP-Referer"]="https://github.com/bramses/chatgpt-md",r["X-Title"]="Obsidian ChatGPT MD Plugin";break;case f:r["x-api-key"]=e,r["anthropic-version"]="2023-06-01";break;case S:r["x-goog-api-key"]=e;break;case g:break;case u:break}return r}};var w=class{constructor(e){this.collectedCitations=new Set;this.tableBuffer="";this.isInTable=!1;this.tableStartPosition=null;this.notificationService=e||new N}insertAssistantHeader(e,t,r){let i=Q(t,F,r),n={line:e.getCursor().line,ch:e.getCursor().ch};e.replaceRange(i,n);let o={line:n.line,ch:n.ch+i.length};return e.setCursor(o),{initialCursor:n,newCursor:o}}parseNonStreamingResponse(e,t){var r,i,n;switch(t){case h:return e.choices[0].message.content;case d:return e.choices[0].message.content;case u:return e.choices[0].message.content;case f:return e.content&&Array.isArray(e.content)?e.content.filter(o=>o.type==="text").map(o=>o.text).join(""):e.content||JSON.stringify(e);case S:if(e.candidates&&e.candidates.length>0){let o=e.candidates[0];if(o.content&&o.content.parts&&o.content.parts.length>0)return o.content.parts.filter(s=>s.text).map(s=>s.text).join("")}return e.text||JSON.stringify(e);case g:return e.message&&e.message.content?e.message.content:e.response?e.response:JSON.stringify(e);default:return((n=(i=(r=e==null?void 0:e.choices)==null?void 0:r[0])==null?void 0:i.message)==null?void 0:n.content)||(e==null?void 0:e.response)||JSON.stringify(e)}}processStreamLine(e,t,r,i,n,o){switch(n){case h:case d:case u:return this.processOpenAIFormat(e,t,r,i,o);case f:return this.processAnthropicFormat(e,t,r,i,o);case S:return this.processGeminiFormat(e,t,r,i,o);case g:return this.processOllamaFormat(e,t,r,i,o);default:return t}}processAnthropicFormat(e,t,r,i,n){if(e.trim()==="")return t;try{if(e.startsWith("event: "))return t;if(e.startsWith("data: ")){let o=e.substring(6).trimStart();if(o==="[DONE]")return t;try{let s=JSON.parse(o);if(s.type==="content_block_delta"){if(s.delta&&s.delta.text)return this.processContentWithTableBuffering(s.delta.text,t,r,n)}else if(s.type==="content_block_start"&&s.content_block&&s.content_block.type==="text"&&s.content_block.text)return this.processContentWithTableBuffering(s.content_block.text,t,r,n)}catch(s){}}return t}catch(o){return t}}processOpenAIFormat(e,t,r,i,n){if(e.trim()==="")return t;try{let o=e.substring(5).trimStart(),s=JSON.parse(o);if(s.citations&&s.citations.length>0)for(let c of s.citations)this.collectedCitations.add(c);if(s.choices&&s.choices[0]){let{delta:c}=s.choices[0];if(c&&c.content)return this.processContentWithTableBuffering(c.content,t,r,n)}return t}catch(o){return t}}processOllamaFormat(e,t,r,i,n){if(e.trim()==="")return t;try{let o=JSON.parse(e);if(o.message&&o.message.content){let s=o.message.content;return this.processContentWithTableBuffering(s,t,r,n)}return o.response?this.processContentWithTableBuffering(o.response,t,r,n):t}catch(o){return t}}processGeminiFormat(e,t,r,i,n){if(e.trim()==="")return t;try{let o=e.substring(5).trimStart();if(o==="[DONE]")return t;let s=JSON.parse(o);if(s.candidates&&s.candidates.length>0){let c=s.candidates[0];if(c.content&&c.content.parts&&c.content.parts.length>0){let l=c.content.parts.filter(p=>p.text).map(p=>p.text).join("");if(l)return this.processContentWithTableBuffering(l,t,r,n)}}return t}catch(o){return t}}async processStreamResponse(e,t,r,i,n,o){let s=e.body.getReader(),c=new TextDecoder,l=!1,p="",m=!1;try{for(;!l;){let{value:A,done:B}=await s.read();if(l=B,l)break;let re=c.decode(A).split(`
`);for(let V of re)V.startsWith("data: [DONE]")||(V.startsWith("data:")?p=this.processStreamLine(V,p,r,i.newCursor,t,n):V.trim()!==""&&(p=this.processStreamLine(V,p,r,i.newCursor,t,n)))}}catch(A){}if(o&&o.wasAborted())return m=!0,o.resetAbortedFlag(),this.resetTableState(),n||r.replaceRange("",i.initialCursor,r.getCursor()),{text:"",wasAborted:m};if(this.isInTable&&this.tableBuffer){if(this.tableStartPosition&&!n){let A=r.getCursor();r.replaceRange(this.tableBuffer,this.tableStartPosition,A),r.setCursor({line:this.tableStartPosition.line,ch:this.tableStartPosition.ch+this.tableBuffer.length})}else n&&r.replaceSelection(this.tableBuffer);p+=this.tableBuffer,this.resetTableState()}if(ze(p)){let A=r.getCursor();r.replaceRange("\n```",A),p+="\n```"}if(this.collectedCitations.size>0){let B=`

**Sources:**
`+Array.from(this.collectedCitations).map((re,V)=>`${V+1}. [${re}](${re})`).join(`
`),$=r.getCursor();r.replaceRange(B,$),r.setCursor({line:$.line,ch:$.ch+B.length}),p+=B,this.collectedCitations.clear()}if(!n){let A=r.getCursor();r.replaceRange("",A,{line:1/0,ch:1/0})}return{text:p,wasAborted:m}}isTableRow(e){let t=e.trim();if(!t.includes("|")||t.length<3||this.isTableSeparator(t))return!1;let r=t.split("|");return r.length>=2&&r.some(i=>i.trim().length>0)}isTableSeparator(e){let t=e.trim();return!t.includes("|")||!t.includes("-")?!1:/^[\|\-\:\s]+$/.test(t)}isTableEnd(e,t){let i=(e+t).split(`
`).filter(n=>n.trim()!=="").pop()||"";return this.isInTable&&!this.isTableRow(i)&&!this.isTableSeparator(i)}isCompleteTable(e){let t=e.split(`
`).filter(o=>o.trim()!=="");if(t.length<2)return!1;let r=!1,i=!1,n=!1;for(let o of t)this.isTableRow(o)?i?n=!0:r=!0:this.isTableSeparator(o)&&(i=!0);return r&&i&&n}resetTableState(){this.isInTable=!1,this.tableBuffer="",this.tableStartPosition=null}processContentWithTableBuffering(e,t,r,i){if(!this.isInTable&&e.includes("|")&&(t.slice(-200)+e).split(`
`).some(l=>{let p=l.trim();return p.includes("|")&&(this.isTableRow(p)||this.isTableSeparator(p))}))return this.isInTable=!0,this.tableBuffer=e,this.tableStartPosition=r.getCursor(),t+e;if(this.isInTable){if(this.tableBuffer+=e,this.shouldFlushTable(this.tableBuffer,e)){let{tableContent:o,remainingContent:s}=this.extractTableFromBuffer(this.tableBuffer);if(this.tableStartPosition&&!i){let c=r.getCursor();r.replaceRange(o,this.tableStartPosition,c),r.setCursor({line:this.tableStartPosition.line,ch:this.tableStartPosition.ch+o.length})}else i&&r.replaceSelection(o);if(this.resetTableState(),s){if(i)r.replaceSelection(s);else{let c=r.getCursor();r.replaceRange(s,c),r.setCursor({line:c.line,ch:c.ch+s.length})}return t+o+s}return t+o}return t+e}if(i)r.replaceSelection(e);else{let n=r.getCursor();r.replaceRange(e,n),r.setCursor({line:n.line,ch:n.ch+e.length})}return t+e}shouldFlushTable(e,t){let r=e.split(`
`);return!!(e.includes(`

`)||this.isCompleteTable(e)&&t.includes(`
`)&&r.slice(-3).filter(c=>c.trim()!=="").some(c=>{let l=c.trim();return l!==""&&!this.isTableRow(l)&&!this.isTableSeparator(l)})||e.length>2e3)}extractTableFromBuffer(e){let r=this.reconstructTableLines(e).split(`
`),i=[],n=[],o=!1;for(let l=0;l<r.length;l++){let p=r[l],m=p.trim();if(!o)if(m===""||this.isTableRow(m)||this.isTableSeparator(m))i.push(p);else{o=!0,n=r.slice(l);break}}let s=i.join(`
`);s&&!s.endsWith(`
`)&&(s+=`
`);let c=n.join(`
`);return{tableContent:s,remainingContent:c}}reconstructTableLines(e){let t=e;return t=t.replace(/\|\|/g,`|
|`),t=t.replace(/\n\n+/g,`
`),t}};var y=class{constructor(e){this.notificationService=e}handleApiError(e,t,r={showNotification:!0,logToConsole:!0,returnForChat:!1}){var l,p,m,A;let i=`[ChatGPT MD] ${t}`,n="",o=((l=r.context)==null?void 0:l.model)||"",s=((p=r.context)==null?void 0:p.url)||"",c=this.formatContextInfo(o,s);if(e instanceof Object?e.name==="AbortError"?n=`${i}: Stream aborted`:e.message===Ye?n=`${i}: Network connection error`:e.status===401||((m=e.error)==null?void 0:m.status)===401?n=`${i}: Authentication failed (401)`:e.status===404||((A=e.error)==null?void 0:A.status)===404?n=`${i}: Resource not found (404)${c?` - ${c}`:""}`:e.error?n=`${i}: ${e.error.message}${c?` - ${c}`:""}`:n=`${i}: ${JSON.stringify(e)}${c?` - ${c}`:""}`:n=`${i}: ${e}${c?` - ${c}`:""}`,r.logToConsole,r.showNotification&&this.notificationService.showNotification(n,5e3),r.returnForChat)return`I am sorry, I could not answer your request because of an error, here is what went wrong-

${e instanceof Object&&e.error?e.error.message:(e==null?void 0:e.message)||e||"undefined"}

Model- ${o}, URL- ${s}`;throw new Error(n)}formatContextInfo(e,t){let r=[];return e&&r.push(`Model: ${e}`),t&&r.push(`URL: ${t}`),r.length>0?r.join(", "):""}handleUrlError(e,t,r){let i=`[ChatGPT MD] Error calling specified URL: ${e}`;return this.notificationService.showNotification(i),`I am sorry, I could not answer your request because of an error, here is what went wrong-

Error connecting to the custom URL.

Model- ${r===g?"llama2":"unknown"}, URL- ${e}`}handleModelError(e,t){let r=`[ChatGPT MD] Error calling model: ${e}`;return this.notificationService.showNotification(r),`I am sorry, there was an error with the model: ${e}. Please check your settings or try a different model.`}handleValidationError(e,t){let r=`[ChatGPT MD] Validation Error: ${e}`;throw this.notificationService.showNotification(r),new Error(r)}};var C=class{constructor(e,t,r,i){this.abortController=null;this.wasStreamingAborted=!1;this.notificationService=t||new N,this.errorService=e||new y(this.notificationService),this.apiAuthService=r||new v,this.apiResponseParser=i||new w}async makeStreamingRequest(e,t,r,i){try{this.abortController=new AbortController;let n=await fetch(e,{method:"POST",headers:r,body:JSON.stringify(t),signal:this.abortController.signal});if(!n.ok)throw await this.handleHttpError(n,i,t,e);if(!n.body)throw new Error("The response body was empty");return n}catch(n){return this.handleRequestError(n,i,t,e)}}async makeNonStreamingRequest(e,t,r,i){try{let o=(await(0,Ie.requestUrl)({url:e,method:"POST",headers:r,contentType:"application/json",body:JSON.stringify(t),throw:!1})).json;return o!=null&&o.error?this.errorService.handleApiError({error:o.error},i,{returnForChat:!0,showNotification:!0,context:{model:t.model,url:e}}):this.apiResponseParser.parseNonStreamingResponse(o,i)}catch(n){return this.errorService.handleApiError(n,i,{returnForChat:!0,showNotification:!0,context:{model:t.model,url:e}})}}async makeGetRequest(e,t,r){try{let i=await(0,Ie.requestUrl)({url:e,method:"GET",headers:t,throw:!1});if(i.status!==200)throw new Error(`Failed to fetch data from ${e}: ${i.status}`);return i.json}catch(i){throw i}}async handleHttpError(e,t,r,i){let n;try{n=await e.json()}catch(s){n={status:e.status,statusText:e.statusText}}let o=this.errorService.handleApiError(n,t,{returnForChat:!1,showNotification:!0,context:{model:r.model,url:i,status:e.status}});return new Error(o)}handleRequestError(e,t,r,i){return this.errorService.handleApiError(e,t,{returnForChat:!1,showNotification:!0,context:{model:r.model,url:i}})}stopStreaming(){this.abortController&&(this.wasStreamingAborted=!0,this.abortController.abort(),this.abortController=null)}wasAborted(){return this.wasStreamingAborted}resetAbortedFlag(){this.wasStreamingAborted=!1}};var x=class{constructor(e,t){this.inferTitleFromMessages=async(e,t,r)=>{try{if(t.length<2)return this.notificationService.showWarning("Not enough messages to infer title. Minimum 2 messages."),"";let i=`Infer title from the summary of the content of these messages. The title **cannot** contain any of the following characters: colon (:), back slash (\\), forward slash (/), asterisk (*), question mark (?), double quote ("), less than (<), greater than (>), or pipe (|) as these are invalid in file names. Just return the title. Write the title in ${r.inferTitleLanguage}. 
Messages:${E}${JSON.stringify(t)}`,n=this.getDefaultConfig(),o={...n,...r};o.model||(o.model=n.model),o.url||(o.url=n.url);try{return await this.callNonStreamingAPIForTitleInference(e,[{role:b,content:i}],o)}catch(s){return""}}catch(i){return this.showNoTitleInferredNotification(),""}};this.notificationService=t!=null?t:new N,this.errorService=e!=null?e:new y(this.notificationService),this.apiService=new C(this.errorService,this.notificationService),this.apiAuthService=new v(this.notificationService),this.apiResponseParser=new w(this.notificationService)}async callAIAPI(e,t={},r,i,n,o,s,c){let l={...this.getDefaultConfig(),...t};return c&&(l.url=i),t.stream&&n?this.callStreamingAPI(s,e,l,n,r,o):this.callNonStreamingAPI(s,e,l)}async inferTitle(e,t,r,i){try{if(!e.file)throw new Error("No active file found");let n=this.getApiKeyFromSettings(t),o=await this.inferTitleFromMessages(n,r,t),s="";return typeof o=="string"?s=o:o&&typeof o=="object"&&(s=o.fullString||""),s&&s.trim().length>0?(await i.writeInferredTitle(e,s.trim()),s.trim()):(this.showNoTitleInferredNotification(),"")}catch(n){return this.showNoTitleInferredNotification(),""}}showNoTitleInferredNotification(){var e;(e=this.notificationService)==null||e.showWarning("Could not infer title. The file name was not changed.")}async callNonStreamingAPIForTitleInference(e,t,r){try{r.stream=!1;let{payload:i,headers:n}=this.prepareApiCall(e,t,r,!0);return await this.apiService.makeNonStreamingRequest(this.getApiEndpoint(r),i,n,this.serviceType)}catch(i){throw i}}stopStreaming(){var e;(e=this.apiService)==null||e.stopStreaming()}processStreamingResult(e){return e.wasAborted&&e.text===""?{fullString:"",mode:"streaming",wasAborted:!0}:{fullString:e.text,mode:"streaming",wasAborted:e.wasAborted}}getApiEndpoint(e){return`${e.url}${Ne[this.serviceType]}`}addPluginSystemMessage(e){return this.supportsSystemField()?e:[{role:this.getSystemMessageRole(),content:Z},...e]}processSystemCommands(e,t){return!t||t.length===0||this.supportsSystemField()?e:[...t.map(i=>({role:this.getSystemMessageRole(),content:i})),...e]}prepareApiCall(e,t,r,i=!1){this.apiAuthService.validateApiKey(e,this.serviceType);let n=i?t:this.addPluginSystemMessage(t),o=this.createPayload(r,n),s=this.apiAuthService.createAuthHeaders(e,this.serviceType);return this.supportsSystemField()&&!i&&!o.system&&(o.system=Z),{payload:o,headers:s}}handleApiCallError(e,t,r=!1){if(!!r)throw e;return this.errorService.handleApiError(e,this.serviceType,{returnForChat:!0,showNotification:!0,context:{model:t.model,url:t.url}})}async defaultCallStreamingAPI(e,t,r,i,n,o){try{let{payload:s,headers:c}=this.prepareApiCall(e,t,r),l=this.apiResponseParser.insertAssistantHeader(i,n,s.model),p=await this.apiService.makeStreamingRequest(this.getApiEndpoint(r),s,c,this.serviceType),m=await this.apiResponseParser.processStreamResponse(p,this.serviceType,i,l,o,this.apiService);return this.processStreamingResult(m)}catch(s){return{fullString:`Error: ${s}`,mode:"streaming"}}}async defaultCallNonStreamingAPI(e,t,r){var i;try{r.stream=!1;let{payload:n,headers:o}=this.prepareApiCall(e,t,r);return{fullString:await this.apiService.makeNonStreamingRequest(this.getApiEndpoint(r),n,o,this.serviceType),model:n.model}}catch(n){let o=t.length===1&&((i=t[0].content)==null?void 0:i.toString().includes("Infer title from the summary"));return this.handleApiCallError(n,r,o)}}},Qe=(a,e)=>{if(e!=null&&e.startsWith("openai@"))return h;if(e!=null&&e.includes(d))return d;if(e!=null&&e.startsWith("lmstudio@"))return u;if(e!=null&&e.startsWith("anthropic@"))return f;if(e!=null&&e.startsWith("gemini@"))return S;if(e!=null&&e.startsWith("ollama@"))return g;if(e!=null&&e.startsWith("local@"))return g;if(e!=null&&e.includes("claude"))return f;if(e!=null&&e.includes("gemini"))return S;if(e!=null&&e.includes("local"))return a!=null&&a.includes("1234")?u:g;if(e!=null&&e.includes("gpt")||e!=null&&e.includes("o1")||e!=null&&e.includes("o3")||e!=null&&e.includes("o4"))return h;let t="openrouter",r="anthropic",i="generativelanguage.googleapis.com",n=["localhost","127.0.0.1"],o="1234";if(a!=null&&a.includes(t))return d;if(a!=null&&a.includes(r))return f;if(a!=null&&a.includes(i))return S;if(a!=null&&a.includes(o))return u;if(n.some(s=>a==null?void 0:a.includes(s)))return g;if(e&&!a)return h},et=a=>{let e=M(a.openrouterApiKey),t=M(a.apiKey),r=M(a.anthropicApiKey),i=M(a.geminiApiKey);return t?h:r?f:i?S:e?d:null};var _={aiService:h,frequency_penalty:0,max_tokens:300,model:"openai@gpt-4",presence_penalty:0,stream:!0,system_commands:null,tags:[],temperature:1,title:"Untitled",top_p:1,url:"https://api.openai.com"},tt=async(a,e)=>{try{let t=new v;if(!M(e))return[];let r=new C,i=t.createAuthHeaders(e,h);return(await r.makeGetRequest(`${a}/v1/models`,i,h)).data.filter(o=>(o.id.includes("o3")||o.id.includes("o4")||o.id.includes("o1")||o.id.includes("gpt-4")||o.id.includes("gpt-3"))&&!o.id.includes("audio")&&!o.id.includes("transcribe")&&!o.id.includes("realtime")&&!o.id.includes("o1-pro")&&!o.id.includes("tts")).sort((o,s)=>o.id<s.id?1:o.id>s.id?-1:0).map(o=>`openai@${o.id}`)}catch(t){return[]}},ae=class extends x{constructor(t,r,i,n,o){super(t,r);this.serviceType=h;this.errorService=t||new y(this.notificationService),this.apiService=i||new C(this.errorService,this.notificationService),this.apiAuthService=n||new v(this.notificationService),this.apiResponseParser=o||new w(this.notificationService)}getDefaultConfig(){return _}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,h)}getSystemMessageRole(){return Pe}supportsSystemField(){return!1}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,n=this.processSystemCommands(r,t.system_commands),o={model:i,messages:n,max_completion_tokens:t.max_tokens,stream:t.stream};return i.includes("search")||i.includes("o1")||i.includes("o4")||(o.temperature=t.temperature,o.top_p=t.top_p,o.presence_penalty=t.presence_penalty,o.frequency_penalty=t.frequency_penalty),o}handleAPIError(t,r,i){let n={model:r.model,url:r.url,defaultUrl:_.url,aiService:h};return t instanceof Object&&r.url!==_.url?this.errorService.handleUrlError(r.url,_.url,h):this.errorService.handleApiError(t,h,{context:n,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,n,o,s){return this.defaultCallStreamingAPI(t,r,i,n,o,s)}async callNonStreamingAPI(t,r,i){return this.defaultCallNonStreamingAPI(t,r,i)}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}};var O={aiService:g,model:"ollama@llama2",url:"http://localhost:11434",stream:!0,title:"Untitled",system_commands:null},rt=async a=>{try{let e=new C,t={"Content-Type":"application/json"};return(await e.makeGetRequest(`${a}/api/tags`,t,g)).models.sort((n,o)=>n.name<o.name?1:n.name>o.name?-1:0).map(n=>`ollama@${n.name}`)}catch(e){return[]}},ce=class extends x{constructor(t,r,i,n,o){super(t,r);this.serviceType=g;this.errorService=t||new y(this.notificationService),this.apiService=i||new C(this.errorService,this.notificationService),this.apiAuthService=n||new v(this.notificationService),this.apiResponseParser=o||new w(this.notificationService)}getDefaultConfig(){return O}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,g)}getSystemMessageRole(){return D}supportsSystemField(){return!1}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,n=this.processSystemCommands(r,t.system_commands);return{model:i,messages:n,stream:t.stream}}handleAPIError(t,r,i){let n={model:r.model,url:r.url,defaultUrl:O.url,aiService:g};return t instanceof Object&&r.url!==O.url?this.errorService.handleUrlError(r.url,O.url,g):this.errorService.handleApiError(t,g,{context:n,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,n,o,s){return this.defaultCallStreamingAPI(t,r,i,n,o,s)}async callNonStreamingAPI(t,r,i){return this.defaultCallNonStreamingAPI(t,r,i)}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}};var P={aiService:d,frequency_penalty:.5,max_tokens:300,model:"anthropic/claude-3-opus:beta",openrouterApiKey:"",presence_penalty:.5,stream:!0,system_commands:null,tags:[],temperature:.3,title:"Untitled",top_p:1,url:"https://openrouter.ai"},it=async(a,e)=>{try{let t=new v;if(!M(e))return[];let r=new C,i=t.createAuthHeaders(e,d);return(await r.makeGetRequest(`${a}/api/v1/models`,i,d)).data.sort((o,s)=>o.id<s.id?1:o.id>s.id?-1:0).map(o=>`${d}@${o.id}`)}catch(t){return[]}},le=class extends x{constructor(t,r,i,n,o){super(t,r);this.serviceType=d;this.errorService=t||new y(this.notificationService),this.apiService=i||new C(this.errorService,this.notificationService),this.apiAuthService=n||new v(this.notificationService),this.apiResponseParser=o||new w(this.notificationService)}getDefaultConfig(){return P}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,d)}getSystemMessageRole(){return D}supportsSystemField(){return!1}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,n=this.processSystemCommands(r,t.system_commands);return{model:i,messages:n,max_tokens:t.max_tokens,temperature:t.temperature,top_p:t.top_p,presence_penalty:t.presence_penalty,frequency_penalty:t.frequency_penalty,stream:t.stream}}handleAPIError(t,r,i){let n={model:r.model,url:r.url,defaultUrl:P.url,aiService:d};return t instanceof Object&&r.url!==P.url?this.errorService.handleUrlError(r.url,P.url,d):this.errorService.handleApiError(t,d,{context:n,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,n,o,s){return this.defaultCallStreamingAPI(t,r,i,n,o,s)}async callNonStreamingAPI(t,r,i){return this.defaultCallNonStreamingAPI(t,r,i)}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}};var T={aiService:u,frequency_penalty:0,max_tokens:300,model:"local-model",presence_penalty:0,stream:!0,system_commands:null,tags:[],temperature:1,title:"Untitled",top_p:1,url:"http://localhost:1234"},nt=async(a,e)=>{try{let t=new v,r=e&&M(e)?t.createAuthHeaders(e,u):{"Content-Type":"application/json"};return(await new C().makeGetRequest(`${a}/v1/models`,r,u)).data.filter(o=>!o.id.includes("embedding")&&!o.id.includes("audio")&&!o.id.includes("transcribe")&&!o.id.includes("tts")).sort((o,s)=>o.id<s.id?1:o.id>s.id?-1:0).map(o=>`lmstudio@${o.id}`)}catch(t){return[]}},pe=class extends x{constructor(t,r,i,n,o){super(t,r);this.serviceType=u;this.errorService=t||new y(this.notificationService),this.apiService=i||new C(this.errorService,this.notificationService),this.apiAuthService=n||new v(this.notificationService),this.apiResponseParser=o||new w(this.notificationService)}getDefaultConfig(){return T}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,u)}getSystemMessageRole(){return D}supportsSystemField(){return!1}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,n=this.processSystemCommands(r,t.system_commands);return{model:i,messages:n,max_completion_tokens:t.max_tokens,stream:t.stream,temperature:t.temperature,top_p:t.top_p,presence_penalty:t.presence_penalty,frequency_penalty:t.frequency_penalty}}handleAPIError(t,r,i){let n={model:r.model,url:r.url,defaultUrl:T.url,aiService:u};return t instanceof Object&&r.url!==T.url?this.errorService.handleUrlError(r.url,T.url,u):this.errorService.handleApiError(t,u,{context:n,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,n,o,s){return this.defaultCallStreamingAPI(t,r,i,n,o,s)}async callNonStreamingAPI(t,r,i){return this.defaultCallNonStreamingAPI(t,r,i)}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}};var R={aiService:f,max_tokens:1024,model:"anthropic@claude-3-5-sonnet-latest",stream:!0,system_commands:null,tags:[],temperature:1,title:"Untitled",url:"https://api.anthropic.com"},ot=async(a,e)=>{try{if(!M(e))return[];let t=`${a.replace(/\/$/,"")}/v1/models`,r=await fetch(t,{method:"GET",headers:{"x-api-key":e,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true","Content-Type":"application/json"}});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);let i=await r.json();return i.data&&Array.isArray(i.data)?i.data.filter(n=>n.type==="model"&&n.id).map(n=>`anthropic@${n.id}`).sort():[]}catch(t){return[]}},me=class extends x{constructor(t,r,i,n,o){super(t,r);this.serviceType=f;this.errorService=t||new y(this.notificationService),this.apiService=i||new C(this.errorService,this.notificationService),this.apiAuthService=n||new v(this.notificationService),this.apiResponseParser=o||new w(this.notificationService)}getDefaultConfig(){return R}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,f)}getSystemMessageRole(){return D}supportsSystemField(){return!0}createPayload(t,r){let i=t.model.includes("@")?t.model.split("@")[1]:t.model,n=this.convertToAnthropicMessages(r),o={model:i,messages:n,max_tokens:t.max_tokens,stream:t.stream};return t.temperature!==void 0&&(o.temperature=t.temperature),o}convertToAnthropicMessages(t){let r=[];for(let i of t){if(i.role===D)continue;let n;i.role===F?n="assistant":n="user",r.push({role:n,content:i.content})}return r}handleAPIError(t,r,i){let n={model:r.model,url:r.url,defaultUrl:R.url,aiService:f};return t instanceof Object&&r.url!==R.url?this.errorService.handleUrlError(r.url,R.url,f):this.errorService.handleApiError(t,f,{context:n,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,n,o,s){return this.defaultCallStreamingAPI(t,r,i,n,o,s)}async callNonStreamingAPI(t,r,i){return this.defaultCallNonStreamingAPI(t,r,i)}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}prepareApiCall(t,r,i,n=!1){this.apiAuthService.validateApiKey(t,this.serviceType);let o=n?r:this.addPluginSystemMessage(r),s=i,c=this.createPayload(s,o),l=this.apiAuthService.createAuthHeaders(t,this.serviceType);if(n)s.system_commands&&s.system_commands.length>0&&(c.system=s.system_commands.join(`

`));else{let p=[];p.push(Z),s.system_commands&&s.system_commands.length>0&&p.push(s.system_commands.join(`

`)),c.system=p.join(`

`)}return l["anthropic-dangerous-direct-browser-access"]="true",{payload:c,headers:l}}};var I={aiService:S,max_tokens:1024,model:"gemini@gemini-1.5-flash",stream:!0,system_commands:null,tags:[],temperature:1,title:"Untitled",top_p:.95,url:"https://generativelanguage.googleapis.com"},st=async(a,e)=>{try{if(!M(e))return[];let t=`${a.replace(/\/$/,"")}/v1beta/models`,r=await fetch(t,{method:"GET",headers:{"x-goog-api-key":e,"Content-Type":"application/json"}});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);let i=await r.json();return i.models&&Array.isArray(i.models)?i.models.filter(n=>n.name&&n.supportedGenerationMethods&&n.supportedGenerationMethods.includes("generateContent")&&!n.name.includes("embedding")).map(n=>`gemini@${n.name.replace("models/","")}`).sort():[]}catch(t){return[]}},de=class extends x{constructor(t,r,i,n,o){super(t,r);this.serviceType=S;this.errorService=t||new y(this.notificationService),this.apiService=i||new C(this.errorService,this.notificationService),this.apiAuthService=n||new v(this.notificationService),this.apiResponseParser=o||new w(this.notificationService)}getDefaultConfig(){return I}getApiKeyFromSettings(t){return this.apiAuthService.getApiKey(t,S)}getSystemMessageRole(){return D}supportsSystemField(){return!1}createPayload(t,r){return{contents:this.convertToGeminiContents(r),generationConfig:{maxOutputTokens:t.max_tokens,temperature:t.temperature,topP:t.top_p}}}convertToGeminiContents(t){let r=[];for(let i of t){let n;i.role===F?n="model":n="user",r.push({role:n,parts:[{text:i.content}]})}return r}handleAPIError(t,r,i){let n={model:r.model,url:r.url,defaultUrl:I.url,aiService:S};return t instanceof Object&&r.url!==I.url?this.errorService.handleUrlError(r.url,I.url,S):this.errorService.handleApiError(t,S,{context:n,showNotification:!0,logToConsole:!0})}async callStreamingAPI(t,r,i,n,o,s){try{let{payload:c,headers:l}=this.prepareApiCall(t,r,i),p=this.apiResponseParser.insertAssistantHeader(n,o,i.model),m=await this.apiService.makeStreamingRequest(this.getApiUrl(i),c,l,this.serviceType),A=await this.apiResponseParser.processStreamResponse(m,this.serviceType,n,p,s,this.apiService);return this.processStreamingResult(A)}catch(c){return{fullString:`Error: ${c}`,mode:"streaming"}}}async callNonStreamingAPI(t,r,i){var n;try{i.stream=!1;let{payload:o,headers:s}=this.prepareApiCall(t,r,i);return{fullString:await this.apiService.makeNonStreamingRequest(this.getApiUrl(i),o,s,this.serviceType),model:i.model}}catch(o){let s=r.length===1&&((n=r[0].content)==null?void 0:n.toString().includes("Infer title from the summary"));return this.handleApiCallError(o,i,s)}}showNoTitleInferredNotification(){this.notificationService.showWarning("Could not infer title. The file name was not changed.")}async callNonStreamingAPIForTitleInference(t,r,i){try{i.stream=!1;let{payload:n,headers:o}=this.prepareApiCall(t,r,i,!0);return await this.apiService.makeNonStreamingRequest(this.getApiUrl(i),n,o,this.serviceType)}catch(n){throw n}}prepareApiCall(t,r,i,n=!1){this.apiAuthService.validateApiKey(t,this.serviceType);let o=n?r:this.addPluginSystemMessage(r),s=i,c=this.createPayload(s,o),l=this.apiAuthService.createAuthHeaders(t,this.serviceType);return l["x-goog-api-key"]=t,{payload:c,headers:l}}getApiUrl(t){let r=t,i=r.model.includes("@")?r.model.split("@")[1]:r.model;return r.stream?`${r.url}/v1beta/models/${i}:streamGenerateContent?alt=sse`:`${r.url}/v1beta/models/${i}:generateContent`}};var he=class{constructor(e,t){this.app=e;this.frontmatterManager=t}async getFrontmatter(e,t){let r={};if(e.file){let l=await this.frontmatterManager.readFrontmatter(e.file);l&&(r={...l})}let i=t.defaultChatFrontmatter?we(t.defaultChatFrontmatter):{},n={...t,...i,...r},o=n.aiService||Qe(n.url,n.model)||et(n)||h;return{...{[h]:_,[g]:O,[d]:P,[u]:T,[f]:R,[S]:I}[o]||_,...t,...i,...r,aiService:o}}async updateFrontmatterField(e,t,r){let i=this.app.workspace.getActiveViewOfType(at.MarkdownView);if(!i||!i.file)return;let n=i.file;try{await this.frontmatterManager.updateFrontmatterField(n,t,r)}catch(o){throw o}}objectToYamlFrontmatter(e){return`---
${Object.entries(e).map(([r,i])=>i==null?`${r}:`:typeof i=="string"?`${r}: "${i}"`:`${r}: ${i}`).join(`
`)}
---

`}generateFrontmatter(e,t={}){if(e.defaultChatFrontmatter){if(Object.keys(t).length>0){let o={...we(e.defaultChatFrontmatter),...t};return this.objectToYamlFrontmatter(o)}return e.defaultChatFrontmatter+`

`}let r=t.aiService||h,i={stream:e.stream,...t};switch(r){case h:i={...i,model:_.model,temperature:_.temperature,top_p:_.top_p,max_tokens:_.max_tokens,presence_penalty:_.presence_penalty,frequency_penalty:_.frequency_penalty};break;case g:i={...i,model:O.model,url:O.url};break;case d:i={...i,model:P.model,temperature:P.temperature,top_p:P.top_p,max_tokens:P.max_tokens,presence_penalty:P.presence_penalty,frequency_penalty:P.frequency_penalty};break;case u:i={...i,model:T.model,url:T.url,temperature:T.temperature,top_p:T.top_p,max_tokens:T.max_tokens,presence_penalty:T.presence_penalty,frequency_penalty:T.frequency_penalty};break;case f:i={...i,model:R.model,url:R.url,temperature:R.temperature,max_tokens:R.max_tokens};break;case S:i={...i,model:I.model,url:I.url,temperature:I.temperature,top_p:I.top_p,max_tokens:I.max_tokens};break}return this.objectToYamlFrontmatter(i)}};var ge=class{constructor(e,t,r,i,n,o){this.app=e;this.fileService=t||new W(e),this.editorContentService=r||new Y(e);let s=new N;if(this.messageService=i||new z(this.fileService,s),!o)throw new Error("FrontmatterService must be provided as it requires FrontmatterManager dependency");this.frontmatterService=o,this.templateService=n||new J(e,this.fileService,this.editorContentService)}async writeInferredTitle(e,t){return this.fileService.writeInferredTitle(e,t)}async ensureFolderExists(e,t){return this.fileService.ensureFolderExists(e,t)}getDate(e,t){return this.fileService.formatDate(e,t)}addHorizontalRule(e,t,r){this.editorContentService.addHorizontalRule(e,t,r)}async clearChat(e){await this.editorContentService.clearChat(e)}moveCursorToEnd(e){this.editorContentService.moveCursorToEnd(e)}async getMessagesFromEditor(e,t){return this.messageService.getMessagesFromEditor(e,t)}async createNewChatFromTemplate(e,t){return this.templateService.createNewChatFromTemplate(e,t)}async createNewChatWithHighlightedText(e,t){return this.templateService.createNewChatWithHighlightedText(e,t)}async getFrontmatter(e,t,r){return await this.frontmatterService.getFrontmatter(e,t)}processResponse(e,t,r){this.messageService.processResponse(e,t,r)}async setModel(e,t){await this.frontmatterService.updateFrontmatterField(e,"model",t)}};var Re={apiKey:"",openrouterApiKey:"",anthropicApiKey:"",geminiApiKey:"",openaiUrl:_.url,openrouterUrl:P.url,ollamaUrl:O.url,lmstudioUrl:T.url,anthropicUrl:R.url,geminiUrl:I.url,chatFolder:"ChatGPT_MD/chats",chatTemplateFolder:"ChatGPT_MD/templates",stream:!0,generateAtCursor:!1,autoInferTitle:!1,dateFormat:ne,headingLevel:We,inferTitleLanguage:je,defaultChatFrontmatter:oe};var fe=require("obsidian");var ue=class extends fe.PluginSettingTab{constructor(e,t,r){super(e,t),this.settingsProvider=r}display(){let{containerEl:e}=this;e.empty();let t=[{id:"apiKey",name:"OpenAI API Key",description:"API Key for OpenAI",type:"text",placeholder:"your openAI API Key",group:"API Keys"},{id:"openrouterApiKey",name:"OpenRouter.ai API Key",description:"API Key for OpenRouter.ai",type:"text",placeholder:"your openRouter API Key",group:"API Keys"},{id:"anthropicApiKey",name:"Anthropic API Key",description:"API Key for Anthropic (Claude)",type:"text",placeholder:"your Anthropic API Key",group:"API Keys"},{id:"geminiApiKey",name:"Gemini API Key",description:"API Key for Google Gemini (Google AI Studio)",type:"text",placeholder:"your Gemini API Key",group:"API Keys"},{id:"openaiUrl",name:"OpenAI API URL",description:`URL for OpenAI API
Default URL: ${_.url}`,type:"text",placeholder:_.url,group:"Service URLs"},{id:"openrouterUrl",name:"OpenRouter.ai API URL",description:`URL for OpenRouter.ai API
Default URL: ${P.url}`,type:"text",placeholder:P.url,group:"Service URLs"},{id:"ollamaUrl",name:"Ollama API URL",description:`URL for Ollama API
Default URL: ${O.url}`,type:"text",placeholder:O.url,group:"Service URLs"},{id:"lmstudioUrl",name:"LM Studio API URL",description:`URL for LM Studio API
Default URL: ${T.url}`,type:"text",placeholder:T.url,group:"Service URLs"},{id:"anthropicUrl",name:"Anthropic API URL",description:`URL for Anthropic API
Default URL: ${R.url}`,type:"text",placeholder:R.url,group:"Service URLs"},{id:"geminiUrl",name:"Gemini API URL",description:`URL for Gemini API
Default URL: ${I.url}`,type:"text",placeholder:I.url,group:"Service URLs"},{id:"defaultChatFrontmatter",name:"Default Chat Frontmatter",description:"Default frontmatter for new chat files. You can change/use all of the settings exposed by the OpenAI API here: https://platform.openai.com/docs/api-reference/chat/create",type:"textarea",placeholder:oe,group:"Chat Behavior"},{id:"stream",name:"Stream",description:"Stream responses from OpenAI",type:"toggle",group:"Chat Behavior"},{id:"generateAtCursor",name:"Generate at Cursor",description:"Generate text at cursor instead of end of file",type:"toggle",group:"Chat Behavior"},{id:"autoInferTitle",name:"Automatically Infer Title",description:"Automatically infer title after 4 messages have been exchanged",type:"toggle",group:"Chat Behavior"},{id:"chatFolder",name:"Chat Folder",description:"Path to folder for chat files",type:"text",group:"Folders"},{id:"chatTemplateFolder",name:"Chat Template Folder",description:"Path to folder for chat file templates",type:"text",placeholder:"chat-templates",group:"Folders"},{id:"dateFormat",name:"Date Format",description:"Date format for chat files. Valid date blocks are: YYYY, MM, DD, hh, mm, ss",type:"text",placeholder:ne,group:"Formatting"},{id:"headingLevel",name:"Heading Level",description:`Heading level for messages (example for heading level 2: '## ${L}${b}'). Valid heading levels are 0, 1, 2, 3, 4, 5, 6`,type:"text",group:"Formatting"},{id:"inferTitleLanguage",name:"Infer title language",description:"Language to use for title inference.",type:"dropdown",options:{English:"English",Japanese:"Japanese",Spanish:"Spanish",French:"French",German:"German",Chinese:"Chinese",Korean:"Korean",Italian:"Italian",Russian:"Russian"},group:"Formatting"}],r={};t.forEach(i=>{r[i.group]||(r[i.group]=[]),r[i.group].push(i)}),Object.entries(r).forEach(([i,n])=>{e.createEl("h3",{text:i}),n.forEach(o=>{this.createSettingElement(e,o)}),e.createEl("hr")})}createSettingElement(e,t){let r=new fe.Setting(e).setName(t.name).setDesc(t.description);t.type==="text"?r.addText(i=>(i.setPlaceholder(t.placeholder||"").setValue(String(this.settingsProvider.settings[t.id])).onChange(async n=>{this.settingsProvider.settings[t.id]=n,await this.settingsProvider.saveSettings()}),i.inputEl.style.width="300px",i)):t.type==="textarea"?r.addTextArea(i=>(i.setPlaceholder(t.placeholder||"").setValue(String(this.settingsProvider.settings[t.id]||t.placeholder)).onChange(async n=>{this.settingsProvider.settings[t.id]=n,await this.settingsProvider.saveSettings()}),i.inputEl.style.width="300px",t.id==="defaultChatFrontmatter"&&(i.inputEl.style.height="260px",i.inputEl.style.minHeight="260px"),i)):t.type==="toggle"?r.addToggle(i=>i.setValue(!!this.settingsProvider.settings[t.id]).onChange(async n=>{this.settingsProvider.settings[t.id]=n,await this.settingsProvider.saveSettings()})):t.type==="dropdown"&&t.options&&r.addDropdown(i=>(i.addOptions(t.options||{}),i.setValue(String(this.settingsProvider.settings[t.id])),i.onChange(async n=>{this.settingsProvider.settings[t.id]=n,await this.settingsProvider.saveSettings()}),i.selectEl.style.width="300px",i))}};var Se=class{constructor(e,t=new N,r=new y(new N)){this.plugin=e;this.notificationService=t;this.errorService=r;this.settings=structuredClone(Re),this.loadSettings().catch(i=>this.notificationService.showError("Failed to load settings"))}getSettings(){return this.settings}async migrateSettings(){let e=[{setting:"ollamaUrl",pattern:/\/api\/$/,replacement:"",description:"Removing trailing /api/ from Ollama URL",introducedIn:"2.1.3"},{setting:"openrouterUrl",pattern:/\/api\/$/,replacement:"",description:"Removing trailing /api/ from OpenRouter URL",introducedIn:"2.1.3"},{setting:"openaiUrl",pattern:/\/$/,replacement:"",description:"Removing trailing slash from OpenAI URL",introducedIn:"2.1.3"}],t=!1;for(let r of e){let i=r.setting,n=this.settings[i];n&&r.pattern.test(n)&&(this.updateSettings({[i]:n.replace(r.pattern,r.replacement)}),t=!0)}t&&await this.saveSettings()}async loadSettings(){let e=await this.plugin.loadData();return Object.assign(this.settings,Re,e),this.settings}async saveSettings(){await this.plugin.saveData(this.settings)}updateSettings(e){Object.assign(this.settings,e)}async addSettingTab(){await this.loadSettings(),this.plugin.addSettingTab(new ue(this.plugin.app,this.plugin,{settings:this.settings,saveSettings:this.saveSettings.bind(this)}))}};var ve=class{constructor(e,t){this.app=e,this.plugin=t,this.initializeServices()}initializeServices(){this.notificationService=new N,this.errorService=new y(this.notificationService),this.apiService=new C(this.errorService,this.notificationService),this.apiAuthService=new v(this.notificationService),this.apiResponseParser=new w(this.notificationService),this.fileService=new W(this.app),this.frontmatterManager=new q(this.app),this.editorContentService=new Y(this.app),this.messageService=new z(this.fileService,this.notificationService),this.frontmatterService=new he(this.app,this.frontmatterManager),this.templateService=new J(this.app,this.fileService,this.editorContentService),this.editorService=new ge(this.app,this.fileService,this.editorContentService,this.messageService,this.templateService,this.frontmatterService),this.settingsService=new Se(this.plugin,this.notificationService,this.errorService)}getAiApiService(e){switch(e){case h:return new ae(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);case g:return new ce(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);case d:return new le(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);case u:return new pe(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);case f:return new me(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);case S:return new de(this.errorService,this.notificationService,this.apiService,this.apiAuthService,this.apiResponseParser);default:throw new Error(`Unknown AI service type: ${e}`)}}getFileService(){return this.fileService}getEditorContentService(){return this.editorContentService}getMessageService(){return this.messageService}getTemplateService(){return this.templateService}getFrontmatterManager(){return this.frontmatterManager}getFrontmatterService(){return this.frontmatterService}getEditorService(){return this.editorService}getNotificationService(){return this.notificationService}getErrorService(){return this.errorService}getApiService(){return this.apiService}getApiAuthService(){return this.apiAuthService}getApiResponseParser(){return this.apiResponseParser}getSettingsService(){return this.settingsService}};var U=require("obsidian");var ee=require("obsidian"),te=class extends ee.SuggestModal{constructor(e,t,r,i=[]){super(e),this.modelNames=i,this.editor=t,this.editorService=r,this.limit=this.modelNames.length,this.modelNames.length>0?this.setPlaceholder("Select Large Language Model"):this.setPlaceholder("Loading available models...")}getSuggestions(e){return this.modelNames.filter(t=>t.toLowerCase().includes(e.toLowerCase()))}renderSuggestion(e,t){t.createEl("div",{text:e})}async onChooseSuggestion(e,t){if(!(this.modelNames.indexOf(e)===-1||this.modelNames.length===0)){new ee.Notice(`Selected model: ${e}`);try{await this.editorService.setModel(this.editor,e)}catch(r){new ee.Notice(`Error setting model: ${r.message}`)}}}};var Ae=class{constructor(e,t,r){this.aiService=null;this.availableModels=[];this.plugin=e,this.serviceLocator=t,this.settingsService=r,this.statusBarItemEl=e.addStatusBarItem(),this.apiAuthService=new v}registerCommands(){this.registerChatCommand(),this.registerSelectModelCommand(),this.registerAddDividerCommand(),this.registerAddCommentBlockCommand(),this.registerStopStreamingCommand(),this.registerInferTitleCommand(),this.registerMoveToNewChatCommand(),this.registerChooseChatTemplateCommand(),this.registerClearChatCommand()}registerChatCommand(){this.plugin.addCommand({id:xe,name:"Chat",icon:"message-circle",editorCallback:async(e,t)=>{var o;let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings(),n=await r.getFrontmatter(t,i,this.plugin.app);this.aiService=this.serviceLocator.getAiApiService(n.aiService);try{let{messagesWithRole:s,messages:c}=await r.getMessagesFromEditor(e,i);i.generateAtCursor||r.moveCursorToEnd(e),U.Platform.isMobile?new U.Notice(`[ChatGPT MD] Calling ${n.model}`):this.updateStatusBar(`Calling ${n.model}`);let l=this.apiAuthService.getApiKey(i,n.aiService),p=await this.aiService.callAIAPI(s,n,k(i.headingLevel),this.getAiApiUrls(n)[n.aiService],e,i.generateAtCursor,l,i);if(r.processResponse(e,p,i),i.autoInferTitle&&Je((o=t==null?void 0:t.file)==null?void 0:o.basename,i.dateFormat)&&s.length>qe){let m={...n,openrouterApiKey:this.apiAuthService.getApiKey(i,d),url:this.getAiApiUrls(n)[n.aiService]};m.model||(n.aiService===h?m.model="gpt-4":n.aiService===g?m.model="llama2":n.aiService===d?m.model="anthropic/claude-3-opus:beta":n.aiService===u?m.model="local-model":n.aiService===f?m.model="claude-3-sonnet-20240229":n.aiService===S&&(m.model="gemini-1.5-flash")),await this.aiService.inferTitle(t,m,c,r)}}catch(s){U.Platform.isMobile&&new U.Notice(`[ChatGPT MD] Calling ${n.model}. `+s,9e3)}this.updateStatusBar("")}})}registerSelectModelCommand(){this.plugin.addCommand({id:"select-model-command",name:"Select Model",icon:"list",editorCallback:async(e,t)=>{let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings(),n=new te(this.plugin.app,e,r,this.availableModels);n.open(),(async()=>{try{let o=await r.getFrontmatter(t,i,this.plugin.app),s=this.apiAuthService.getApiKey(i,h),c=this.apiAuthService.getApiKey(i,d),l={[h]:o.openaiUrl||i.openaiUrl||_.url,[d]:o.openrouterUrl||i.openrouterUrl||P.url,[g]:o.ollamaUrl||i.ollamaUrl||O.url,[u]:o.lmstudioUrl||i.lmstudioUrl||T.url,[f]:o.anthropicUrl||i.anthropicUrl||R.url,[S]:o.geminiUrl||i.geminiUrl||I.url},p=await this.fetchAvailableModels(l,s,c),m=new Set(this.availableModels),A=new Set(p);(this.availableModels.length!==p.length||![...m].every($=>A.has($))||![...A].every($=>m.has($)))&&p.length>0&&(this.availableModels=p,n.close(),new te(this.plugin.app,e,r,this.availableModels).open())}catch(o){}})()}})}registerAddDividerCommand(){this.plugin.addCommand({id:Fe,name:"Add divider",icon:"minus",editorCallback:async(e,t)=>{let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings();r.addHorizontalRule(e,b,i.headingLevel)}})}registerAddCommentBlockCommand(){this.plugin.addCommand({id:Oe,name:"Add comment block",icon:"comment",editorCallback:(e,t)=>{let r=e.getCursor(),i=r.line,n=r.ch,o=`${Ke}${E}${Be}`;e.replaceRange(o,r);let s={line:i+1,ch:n};e.setCursor(s)}})}registerStopStreamingCommand(){this.plugin.addCommand({id:Le,name:"Stop streaming",icon:"octagon",callback:()=>{this.aiService&&"stopStreaming"in this.aiService?this.aiService.stopStreaming():this.serviceLocator.getNotificationService().showWarning("No active streaming request to stop")}})}registerInferTitleCommand(){this.plugin.addCommand({id:ke,name:"Infer title",icon:"subtitles",editorCallback:async(e,t)=>{let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings(),n=await r.getFrontmatter(t,i,this.plugin.app);if(this.aiService=this.serviceLocator.getAiApiService(n.aiService),!n.model)return;this.updateStatusBar(`Calling ${n.model}`);let{messages:o}=await r.getMessagesFromEditor(e,i),s={...i,...n,openrouterApiKey:this.apiAuthService.getApiKey(i,d),url:this.getAiApiUrls(n)[n.aiService]};await this.aiService.inferTitle(t,s,o,r),this.updateStatusBar("")}})}registerMoveToNewChatCommand(){this.plugin.addCommand({id:De,name:"Create new chat with highlighted text",icon:"highlighter",editorCallback:async(e,t)=>{let r=this.serviceLocator.getEditorService(),i=this.settingsService.getSettings();try{await r.createNewChatWithHighlightedText(e,i)}catch(n){new U.Notice("[ChatGPT MD] Error in Create new chat with highlighted text, check console")}}})}registerChooseChatTemplateCommand(){this.plugin.addCommand({id:Ge,name:"Create new chat from template",icon:"layout-template",callback:async()=>{let e=this.serviceLocator.getEditorService(),t=this.settingsService.getSettings();if(t.dateFormat){await e.createNewChatFromTemplate(t,e.getDate(new Date,t.dateFormat));return}new U.Notice("date format cannot be empty in your ChatGPT MD settings. You can choose something like YYYYMMDDhhmmss")}})}registerClearChatCommand(){this.plugin.addCommand({id:Ue,name:"Clear chat (except frontmatter)",icon:"trash",editorCallback:async(e,t)=>{await this.serviceLocator.getEditorService().clearChat(e)}})}getAiApiUrls(e){return{openai:e.openaiUrl||_.url,openrouter:e.openrouterUrl||P.url,ollama:e.ollamaUrl||O.url,lmstudio:e.lmstudioUrl||T.url,anthropic:e.anthropicUrl||R.url,gemini:e.geminiUrl||I.url}}async initializeAvailableModels(){try{let e=this.settingsService.getSettings(),t=this.apiAuthService.getApiKey(e,h),r=this.apiAuthService.getApiKey(e,d),i={[h]:e.openaiUrl||_.url,[d]:e.openrouterUrl||P.url,[g]:e.ollamaUrl||O.url,[u]:e.lmstudioUrl||T.url,[f]:e.anthropicUrl||R.url,[S]:e.geminiUrl||I.url};this.availableModels=await this.fetchAvailableModels(i,t,r)}catch(e){this.availableModels=[]}}async fetchAvailableModels(e,t,r){function i(n,o,s){return Promise.race([n,new Promise(c=>setTimeout(()=>c(s),o))])}try{let n=[];n.push(i(rt(e[g]),K,[])),n.push(i(nt(e[u]),K,[])),M(t)&&n.push(i(tt(e[h],t),K,[])),M(r)&&n.push(i(it(e[d],r),K,[]));let o=this.apiAuthService.getApiKey(this.settingsService.getSettings(),f);M(o)&&n.push(i(ot(e[f],o),K,[]));let s=this.apiAuthService.getApiKey(this.settingsService.getSettings(),S);return M(s)&&n.push(i(st(e[S],s),K,[])),(await Promise.all(n)).flat()}catch(n){return new U.Notice("Error fetching models: "+(n instanceof Error?n.message:String(n))),[]}}updateStatusBar(e){this.statusBarItemEl.setText(`[ChatGPT MD] ${e}`)}};var Ee=class extends ct.Plugin{async onload(){this.serviceLocator=new ve(this.app,this);let e=this.serviceLocator.getSettingsService();await e.loadSettings(),await e.migrateSettings(),await e.addSettingTab(),this.commandRegistry=new Ae(this,this.serviceLocator,e),this.commandRegistry.registerCommands(),this.commandRegistry.initializeAvailableModels().catch(t=>{})}};

/* nosourcemap */